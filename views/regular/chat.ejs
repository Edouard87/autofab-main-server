<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <%- include ../../partials/regular/global-header.ejs %>
</head>

<body>
  <% include ../../partials/regular/navbar.ejs %>
  <div class="page-content">
    <div class="chatbox">

    </div>
    <div class="msgbox">
        <form class="ajax-form" action="/chats/message" method="post">
            <!-- The chat ID -->
            <input type="hidden" name="_id">
            <!-- The Message -->
            <input type="text" name="message">
            <button>Send</button>
        </form>
    </div>
    <div class="linkedcontrols">
        <h1>Not Linked</h1>
    </div>
    <script>
       $("input[name='_id'").val((new URLSearchParams(location.href.split("?")[1])).get("id"))
       var currentData = new Array()
       $(".ajax-form").on('success', () => {
           $("input[name='message'").val("")
       })
       setInterval(function() {
        var chatMessageTemplate = new String();
        $.ajax({
            url: "/templates/chat/message.mustache",
            method: "get",
            success: function(template) {
                chatMessageTemplate = template
            }
        })
        $.ajax({
            url: "/chats/messages/all",
            type: "get",
            data: {id: $("input[name='_id']").val()},
            success: data => {
                var timesArray = new Array()
                if (data.length > currentData.length) {
                    $(".chatbox").empty()
                    currentData = data
                    data.forEach(msg => {
                        timesArray.push(msg.time)
                        if (msg.type == "message") {
                              $(".chatbox").append(Mustache.to_html(chatMessageTemplate, {
                                  username: msg.owner,
                                  message: msg.data,
                                  time: moment.unix(Math.floor(msg.time / 1000)).format("MMMM DD, YYYY") + " at "
                                  +moment.unix(Math.floor(msg.time / 1000)).format("hh:mm A")
                              }))
                        }
                    })
                    $(".chatbox").animate({
                        scrollTop: $(".chatbox")[0].scrollHeight
                    },2000)
                }
                
            }
        })
       },1000)

    </script>
    <style>
        .chatbox {
            width: 100%;
            height: 200px;
            background-color: grey;
            /* display: inline-block; */
            overflow-y: scroll;
            padding: 10px;
        }
        .chatbox-message span {
            display: block;
            width: 100%;
        }
        .chatbox-message .username {
            font-weight: bold;
        }
        .chatbox-message .time {
            font-size: 10px;
        }
    </style>
  </div>
</body>

</html>