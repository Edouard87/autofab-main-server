<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <%- include ../partials/global-header.ejs %>
</head>
<body>
  
  <%- include ../partials/navbar.ejs %>
  <div class="page-content">
    <h1>Calendar</h1>
    <p class="calendar-text"> Display reservations for the </p>
    <select class="calendar-dropdown" id="machine-schedule" style="display:none">
      <% for (var i = 0; i < req.machines.length; i++ ) { %>
      <option value="<%= req.machines[i].id %>"><%= req.machines[i].name %></option>
      <% } %>
    </select>
    <p class="calendar-text"> on </p>
    <input type="date" class="calendar-date-picker" id="machine-schedule-day">
    <button class="btn btn-outline-success reserve-collapsable">Make a new Reservation</button>
    <%- include ../partials/reservation.ejs %>
    <div class="calendar-panel" id="schedule"></div>
    <div class="calendar-panel" id="schedule-lines"></div>
  </div>

  <style>
    .reserve-collapsable {
      display: block !important;
      margin-top: 10px;
    }
  </style>
  
  <script src="/js/reservations.js"></script>

  <script>

    // submitting the form

    
    

    // collapsable menu

    var buttonState = 1;

    $(".reserve-collapsable").trigger("click")

    $(".reserve-collapsable").on("click", (event) => {

      if (buttonState == 0) {
        $(".reservation-form").css("display","none");
        $(".reserve-collapsable").html("Make a new Reservation")
        $(".calendar-panel").css("top","300px")
        buttonState++
      } else {
        $(".reservation-form").css("display","block");
        $(".reserve-collapsable").html("Cancel")
        $(".calendar-panel").css("top","550px")
        buttonState--
      }

      
      // console.log(this)

    });

    // Important variables
    // 1 minute = 0.5 pt

    var scale = 0.5
    var markerHeight = 24;

    // Format pages

    $("#schedule").css("height",(24*60*scale) + "px")
    $("#schedule-lines").css("height",(24*60*scale) + "px")

    for (var i = 0; i < 24; i++) {
      $("#schedule-lines").append("<hr class='time-divider' style='" + "top: " + (i*60*scale) + "px" + "'>")
      $("#schedule-lines").append("<p class='hour-marker' style='" + "top: " + ((i*60*scale) - (markerHeight * 0.5)) + "px" + "' height='" + markerHeight + "px" + "'>" + i + "</p>")
    }

    var template;

    $.ajax({

      url: "/templates/schedule-block.html",
      method: "get",
      success: function(data) {

        template = data;
        $("#machine-schedule").css("display","inline");

      }

    });

    var startMins;
    var endMins;

    function getSchedule(id, date) {

      $.ajax({
        url: "/schedule/" + id + "/" + date,
        method: "get",
        success: function(data) {

          console.log(data)

          $("#schedule").empty();

          var startDate;
          var endDate;
          var displayText;

          for (var i = 0; i < data.length; i++) {

            startMins = (new Date(data[i].start * 1000).getHours()*60) + new Date(data[i].start * 1000).getMinutes();
            endMins = (new Date(data[i].end * 1000).getHours()*60) + new Date(data[i].end * 1000 ).getMinutes();
            duration = endMins-startMins;

            if (duration >= 60) {
              displayText = "block"
            } else {
              displayText = "none"
            }

            startDate = new Date(data[i].start * 1000)
            endDate = new Date(data[i].end * 1000)

            // scale

            $("#schedule").append(Mustache.to_html(template, { 
              name: data[i].username, 
              startHours: startDate.getHours(),
              startMinutes: leadingZeroes(startDate.getMinutes()),
              endHours: endDate.getHours(),
              endMinutes: leadingZeroes(endDate.getMinutes()),
              height: (duration * scale) + "px",
              top: (startMins * scale) + "px",
              displayText: displayText
            }));
          }

        } 
      });

    }

    $(".calendar-date-picker").on("change", function() {

      console.log("changing...")
      getSchedule($("#machine-schedule").val(),formatDate($(this).val()));

    })

  </script>

</body>
</html>