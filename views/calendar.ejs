<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <%- include ../partials/global-header.ejs %>
</head>
<body>
  <!-- Modals -->
  <!-- General Purpose Dialogues -->
  <% include ../partials/success-modal.ejs %>
  <!-- File Upload Modal -->
  <!-- View Reservation Modal -->
  <div class="modal fade" id="file-upload-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add File</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h1>All Files</h1>
          <div id="uploaded-files">

          </div>
          <h1>Upload a new file</h1>
          <form id="new-file-form" action="/reservations/approve">
            <input id="file" type="file" name="file">
          </form>
          <button class="btn btn-sm btn-secondary" id="upload-file">Upload File</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn modify-button btn-primary modal-button modal-button-ajax-action"
            data-dismiss="modal">Select File</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    $("#upload-file").on("click",() => {
      var data = new FormData($('#new-file-form')[0]);
      console.log(data.has("file"))
      $.ajax({
        url: '/files/upload',
        data: data,
        cache: false,
        contentType: false,
        processData: false,
        method: 'POST'
      })
    })
     ajaxTable.summon($("#uploaded-files"),{
      url: "/files/all",
      method: "get",
      id: "uploaded-files-table",
      ignore: ["_id"],
      firstCap: true,
      action: false
    },()=> {
      ajaxTable.connect($("#uploaded-files-table").children().first(),{
        validator: (e) => {
          // e.start = humanReadableTime(new Date(e.start * 1000))
          // e.end = humanReadableTime(new Date(e.end * 1000))
          // e.machine = $("option[value='" + e.machine + "']").html()
        },
        preSend: () => {},
        actionName: "Manage",
        actionClasses: ["btn","btn-sm","btn-warning"]
      })
    })
  </script>
  <%- include ../partials/navbar.ejs %>
  <div class="page-content">

    <div class="card w-25 p-3 float-right">
      <div class="card-body">
        <h5 class="card-title">Calendar</h5>
        <!-- <h6 class="card-subtitle mb-2 text-muted">Panel subtitle</h6> -->
        <p class="card-text">
          <form id="reservation-form" class="ajax-form" method="post" action="/reservations/new">
            <h1>View Options</h1>
            <label for="machine-schedule">Machine: </label><select name="machine" id="machine-schedule">
              <% for (var i = 0; i < req.machines.length; i++ ) { %>
              <option value="<%= req.machines[i].id %>"><%= req.machines[i].name %></option>
              <% } %>
            </select>
            <% if (req.decoded.permission == -1) { %>
              <label for="user-dropdwon">User: </label><select id="user-dropdwon" name="username">
                <% for (var i = 0; i < req.users.length; i++ ) { %>
                <option value="<%= req.users[i].username %>"><%= req.users[i].username %></option>
                <% } %>
              </select>
            <% } %>
            <input required id="date" class="calendar-date-picker" name="date" type="date">
            <h1>New Reservation</h1>
            <label for="start-time">Start Time: </label>
            <input class="wicked-picker" required id="start-time" name="start" type="time">
            <label for="end-time">End Time: </label>
            <input class="wicked-picker" required id="end-time" name="end" type="time">
            <textarea style="width: 100%" name="justification" placeholder="Enter a reason here"></textarea>
            <input id="file-form" type="hidden" name="file">
          </form>
          <button id="add-file">Add File</button>
        </p>
        <button type="button" class="btn btn-primary" data-dismiss="modal" id="res-create">Create Reservation</button>
      </div>
    </div>

     <script>
       $(document).ready(() => {
         $("#res-create").on("click", () => {
           ajaxForm.submit($("#reservation-form"))
         });
         console.log("READY!")
         $("#add-file").on('click', () => {
           console.log("CLICKED!")
           $("#file-upload-modal").modal("toggle")
         })
       })
     </script>

    <script>
      var start;
      var end;

      function checkTimeFields() {

        start = Math.floor(new Date($("#date").val() + " " + $("#start-time").val()).getTime() / 1000);
        end = Math.floor(new Date($("#date").val() + " " + $("#end-time").val()).getTime() / 1000);
        console.log(start);
        console.log(end);
        if (start >= end) {

          $(".warn").fadeIn();
          $(".submit-reservation").attr("disabled", true)

        } else {

          $(".warn").fadeOut();
          $(".submit-reservation").attr("disabled", false)

        }

      }

      $("#start-time").on('keyup', function () {
        checkTimeFields()
      });
      $("#end-time").on('keyup', function () {
        checkTimeFields()
      });
      $("form[action='/reservations/new']").on("success", () => {
        getSchedule($("#machine-schedule").val(), formatDate($(".calendar-date-picker").val()));
      })
    </script>
    <!-- Calendar itself is below -->
    <div class="calendar-panel" id="schedule"></div>
    <div class="calendar-panel" id="schedule-lines"></div>
  </div>

  <style>
    #reservation-form * {
      display: block;
      margin: 10px
    }
  </style>
  
  <script src="/js/reservations.js"></script>

  <script>

    // submitting the form

    
    

    // collapsable menu

    var buttonState = 1;

    $(".reserve-collapsable").trigger("click")

    $(".reserve-collapsable").on("click", (event) => {

      if (buttonState == 0) {
        $(".reservation-form").css("display","none");
        $(".reserve-collapsable").html("Make a new Reservation")
        $(".calendar-panel").css("top","300px")
        buttonState++
      } else {
        $(".reservation-form").css("display","block");
        $(".reserve-collapsable").html("Cancel")
        $(".calendar-panel").css("top","550px")
        buttonState--
      }

      
      // console.log(this)

    });

    // Important variables
    // 1 minute = 0.5 pt

    var scale = 0.5
    var markerHeight = 24;

    // Format pages

    $("#schedule").css("height",(24*60*scale) + "px")
    $("#schedule-lines").css("height",(24*60*scale) + "px")

    for (var i = 0; i < 24; i++) {
      $("#schedule-lines").append("<hr class='time-divider' style='" + "top: " + (i*60*scale) + "px" + "'>")
      $("#schedule-lines").append("<p class='hour-marker' style='" + "top: " + ((i*60*scale) - (markerHeight * 0.5)) + "px" + "' height='" + markerHeight + "px" + "'>" + i + "</p>")
    }

    var template;

    $.ajax({

      url: "/templates/schedule-block.mustache",
      method: "get",
      success: function(data) {

        template = data;
        $("#machine-schedule").css("display","inline");

      }

    });

    var startMins;
    var endMins;

    function getSchedule(id, date) {

      $.ajax({
        url: "/schedule/" + id + "/" + date,
        method: "get",
        success: function(data) {

          console.log(data)

          $("#schedule").empty();

          var startDate;
          var endDate;
          var displayText;
          var status;

          for (var i = 0; i < data.length; i++) {

            startMins = (new Date(data[i].start * 1000).getHours()*60) + new Date(data[i].start * 1000).getMinutes();
            endMins = (new Date(data[i].end * 1000).getHours()*60) + new Date(data[i].end * 1000 ).getMinutes();
            duration = endMins-startMins;

            if (duration >= 60) {
              displayText = "block"
            } else {
              displayText = "none"
            }

            // status = data[i].status

            startDate = new Date(data[i].start * 1000)
            endDate = new Date(data[i].end * 1000)

            // scale

            $("#schedule").append(Mustache.to_html(template, { 
              name: data[i].username, 
              startHours: startDate.getHours(),
              startMinutes: leadingZeroes(startDate.getMinutes()),
              endHours: endDate.getHours(),
              endMinutes: leadingZeroes(endDate.getMinutes()),
              height: (duration * scale) + "px",
              top: (startMins * scale) + "px",
              displayText: displayText,
              status: data[i].status
            }));
          }

        } 
      });

    }

    $(".calendar-date-picker").on("change", function() {

      console.log("changing...")
      getSchedule($("#machine-schedule").val(),formatDate($(this).val()));

    })

  </script>

</body>
</html>